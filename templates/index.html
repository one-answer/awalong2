<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="阿瓦隆(Avalon)在线游戏，经典的桌游电子版">
    <meta name="keyword" content="阿瓦隆, Avalon, 在线游戏, 桌游, 社交推理, 多人游戏, 中世纪, 正义与邪恶, 角色扮演">
    <title>阿瓦隆游戏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" href="https://storage.xxlb.org/awalong1.png">
    <link rel="apple-touch-icon" href="https://storage.xxlb.org/awalong1.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3811349067654166"
            crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7EX0NVXWMZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7EX0NVXWMZ');
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            background-image: url('https://img.freepik.com/free-photo/medieval-castle-night-with-fog-full-moon_124715-13.jpg');
            background-size: cover;
            background-attachment: fixed;
            color: #333;
            line-height: 1.6;
        }
        .game-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.92);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        h1.main-title {
            color: #a37d28;
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 2px;
            font-family: 'Times New Roman', Times, serif;
        }
        .title-subtitle {
            text-align: center;
            color: #555;
            font-style: italic;
            margin-top: -20px;
            margin-bottom: 30px;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
            margin-bottom: 30px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .card-title {
            color: #7e4a21;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .card-body {
            padding: 25px;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 1rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        .btn:hover::after {
            animation: ripple 1s ease-out;
        }
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        .btn-primary {
            background-color: #7e4a21;
            color: white;
        }
        .btn-primary:hover {
            background-color: #5e3718;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: #4d6a10;
            color: white;
        }
        .btn-success:hover {
            background-color: #3a500c;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #bb2d3b;
            transform: translateY(-2px);
        }
        #main-menu {
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            background-image: url('https://img.freepik.com/free-photo/old-paper-texture_1194-6118.jpg?w=996&t=st=1715837284~exp=1715837884~hmac=3b8c0a4d86a2e02a0b5da2c4a2fb64e6dc7ae5de2d1e83c66cbfa48eb6b169ab');
            background-size: cover;
        }
        #main-menu .card-body {
            padding: 40px;
        }
        #main-menu .btn {
            min-width: 180px;
            margin: 10px;
            font-size: 1.1rem;
            padding: 12px 24px;
        }
        #create-view, #join-view {
            background: white;
        }
        .room-header {
            margin-bottom: 30px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        .room-code {
            font-size: 2rem;
            font-weight: 700;
            color: #7e4a21;
            letter-spacing: 3px;
            margin: 15px 0;
            display: block;
            text-align: center;
            text-transform: uppercase;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .room-code-container {
            position: relative;
            margin: 15px auto;
            max-width: 300px;
        }
        .copy-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #7e4a21;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .copy-button:hover {
            background-color: #5e3718;
        }
        .copy-message {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .copy-message.show {
            opacity: 1;
        }
        .player-count {
            font-size: 1.2rem;
            color: #6c757d;
            margin-top: 10px;
        }
        .players-list {
            margin: 30px 0;
        }
        .players-list h3 {
            color: #2e4172;
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .player-item {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3266c1;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        .player-item:hover {
            transform: translateX(5px);
            background-color: #e9ecef;
        }
        .player-item.host {
            border-left-color: #38b000;
            font-weight: 600;
        }
        .player-number {
            font-weight: 700;
            margin-right: 12px;
            display: inline-block;
            background-color: #7e4a21;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .host-controls {
            margin-top: 30px;
            text-align: center;
        }
        .start-button {
            min-width: 200px;
            padding: 12px 25px;
            font-size: 1.1rem;
            background-color: #4d6a10;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
            background-color: #3a500c;
        }
        .start-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .waiting-message {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        /* Game View Styles */
        #game-view {
            background: white;
        }
        #game-view .card-body {
            padding: 0;
        }
        .game-header {
            background: linear-gradient(135deg, #2e2418 0%, #1a1510 100%);
            color: #e0d2b4;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }
        .game-header h2 {
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .game-header p {
            margin: 5px 0;
            font-size: 1.1rem;
        }
        .game-content {
            padding: 25px;
        }
        .role-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3266c1;
        }
        .role-info .self-info {
            font-size: 1.1rem;
        }
        .role-info p {
            margin: 8px 0;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .player-card {
            position: relative;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .player-card.leader {
            border: 2px solid #ffc107;
        }
        .player-card.self {
            border: 2px solid #3266c1;
        }
        .player-card.selected-team {
            border: 2px solid #38b000;
        }
        .player-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 10px 0;
        }
        .player-role, .player-team {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .leader-badge, .team-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #ffc107;
            color: #212529;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .team-badge {
            background-color: #38b000;
            color: white;
            top: auto;
            bottom: -10px;
        }
        .quest-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .quest-status div {
            margin: 8px 0;
            font-size: 1rem;
        }
        .leader-controls, .quest-vote-controls, .next-leader-selection {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        .team-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .form-check {
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .form-check:hover {
            background-color: #f8f9fa;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .form-check.selected {
            background-color: #e6f4ff;
            border: 1px solid #1890ff;
        }
        
        .form-check input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .form-check label {
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
        }
        
        .player-details {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .magic-token {
            display: inline-block;
            margin-left: 10px;
            background-color: #8e44ad;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .magic-token-button {
            background-color: #8e44ad;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 5px;
            margin-left: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .magic-token-button:hover {
            background-color: #6c3483;
        }
        .magic-token-info {
            background-color: #f1e7f8;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid #8e44ad;
            font-size: 0.9rem;
        }
        .magic-token-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f0ff;
            border-radius: 8px;
            border: 1px dashed #8e44ad;
        }
        .magic-token-target-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        .magic-token-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            margin-bottom: 10px;
        }
        .vote-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .success-button, .fail-button {
            min-width: 150px;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .success-button {
            background-color: #38b000;
            color: white;
        }
        .success-button:hover {
            transform: translateY(-3px) scale(1.05);
            background-color: #2d8c00;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .fail-button {
            background-color: #dc3545;
            color: white;
        }
        .fail-button:hover {
            transform: translateY(-3px) scale(1.05);
            background-color: #bb2d3b;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .select-leader-button {
            padding: 8px 16px;
            background-color: #3266c1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .select-leader-button:hover {
            background-color: #274d94;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .game-over {
            text-align: center;
            padding: 30px;
            margin: 20px 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        .winner-announcement {
            font-size: 2rem;
            font-weight: 700;
            margin: 20px 0;
            color: #2e4172;
        }
        .final-results {
            margin: 20px 0;
            font-size: 1.2rem;
        }
        .new-game-button {
            min-width: 200px;
            padding: 12px 25px;
            background-color: #3266c1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .new-game-button:hover {
            transform: translateY(-3px);
            background-color: #274d94;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .vote-result {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .result-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .vote-badge {
            padding: 10px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px;
            display: inline-block;
        }
        .waiting-text {
            color: #6c757d;
            font-style: italic;
        }
        
        /* Game Rules Styles */
        .rules-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .accordion-button {
            background-color: #7e4a21;
            color: white;
            font-weight: 600;
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 1.2rem;
        }
        
        .accordion-button:not(.collapsed) {
            background-color: #5e3718;
            color: white;
        }
        
        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(126, 74, 33, 0.25);
            border-color: #7e4a21;
        }
        
        .accordion-button::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
        }
        
        .rules-content {
            padding: 20px;
            font-size: 1rem;
            color: #333;
        }
        
        .rules-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .rules-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .rules-section h3 {
            color: #7e4a21;
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .rules-section h4 {
            color: #2e4172;
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .rules-section ul, .rules-section ol {
            padding-left: 20px;
        }
        
        .rules-section li {
            margin-bottom: 8px;
        }
        
        .roles-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .roles-column {
            flex: 1;
            min-width: 250px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .roles-column:first-child {
            border-left-color: #3266c1;
        }
        
        .roles-column:last-child {
            border-left-color: #dc3545;
        }
        
        /* Styles for next leader selection */
        #next-leader-selection {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        
        #next-leader-selection h3 {
            color: #2e4172;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        
        #next-leader-selection .alert {
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        #next-leader-selection .alert p {
            margin-bottom: 10px;
        }
        
        #next-leader-selection .alert i {
            margin-right: 8px;
        }
        
        #next-leader-selection .player-card {
            transition: all 0.3s;
            border: 1px solid #dee2e6;
        }
        
        #next-leader-selection .player-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            border-color: #3266c1;
        }
        
        #waiting-next-leader {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        #waiting-next-leader h4 {
            color: #2e4172;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        #waiting-next-leader .alert {
            border-radius: 10px;
        }
        
        #waiting-next-leader .alert p {
            margin-bottom: 10px;
        }
        
        .disabled-player {
            opacity: 0.6;
            background-color: #f1f1f1;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .disabled-player:hover {
            transform: none;
            box-shadow: none;
        }
        
        .select-leader-button.disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .select-leader-button.disabled:hover {
            transform: none;
            background-color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="main-title">阿瓦隆传奇</h1>
        <p class="title-subtitle">亚瑟王的骑士们，正义与邪恶的终极对决</p>
        
        <!-- 主菜单 -->
        <div id="main-menu" class="card mb-4">
            <div class="card-body text-center">
                <h5 class="card-title">欢迎来到阿瓦隆游戏</h5>
                <p class="mb-4">探索正义与邪恶的史诗对决，展开你的冒险吧！</p>
                <div class="d-flex justify-content-center flex-wrap">
                    <button class="btn btn-primary m-2" onclick="showCreateRoom()">创建房间</button>
                    <button class="btn btn-success m-2" onclick="showJoinRoom()">加入房间</button>
                </div>
            </div>
        </div>

        <!-- 创建房间 -->
        <div id="create-view" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">创建新房间</h5>
                <p class="text-muted mb-4">创建一个新的游戏房间，邀请你的朋友加入吧！</p>
                <div class="mb-4">
                    <label for="player-count" class="form-label">选择玩家数量</label>
                    <select class="form-select" id="player-count">
                        <option value="4">4人游戏</option>
                        <option value="5">5人游戏</option>
                        <option value="6">6人游戏</option>
                        <option value="7">7人游戏</option>
                        <option value="8">8人游戏</option>
                        <option value="9">9人游戏</option>
                        <option value="10">10人游戏</option>
                    </select>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-secondary" onclick="showMainMenu()">返回</button>
                    <button class="btn btn-primary" onclick="createRoom()">创建房间</button>
                </div>
            </div>
        </div>

        <!-- 加入房间 -->
        <div id="join-view" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">加入房间</h5>
                <p class="text-muted mb-4">输入房间代码加入已有的游戏</p>
                <div class="mb-4">
                    <label for="join-room-code" class="form-label">房间代码</label>
                    <input type="text" id="join-room-code" class="form-control" maxlength="4" placeholder="输入4位房间代码" required>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-secondary" onclick="showMainMenu()">返回</button>
                    <button onclick="joinRoom()" class="btn btn-success">加入房间</button>
                </div>
            </div>
        </div>

        <!-- 房间界面 -->
        <div id="room-view" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h5 class="card-title text-center">游戏房间</h5>
                <div id="room-info"></div>
                <div class="text-center">
                    <button class="btn btn-danger mt-3" onclick="leaveRoom()">离开房间</button>
                </div>
            </div>
        </div>

        <!-- 游戏界面 -->
        <div id="game-view" class="card mb-4" style="display: none;">
            <div class="game-header">
                <h2>阿瓦隆传奇</h2>
                <div id="game-status-header"></div>
            </div>
            <div class="game-content">
                <!-- 个人角色信息 -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">你的角色信息</h6>
                    <div id="my-role-info" class="role-info"></div>
                </div>

                <!-- 玩家列表 -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">玩家信息</h6>
                    <div id="players-list" class="players-grid"></div>
                </div>

                <!-- 任务信息 -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">任务信息</h6>
                    <div id="quest-info" class="quest-info"></div>
                </div>

                <!-- 领袖选择界面 -->
                <div id="leader-controls" class="mb-4" style="display: none;">
                    <h6 class="fw-bold mb-3">选择任务队员</h6>
                    <div id="team-selection"></div>
                    <div class="magic-token-container" id="magic-token-container">
                        <div class="magic-token-info">
                            作为本轮队长，你可以派发一个魔法指示物给任意一位队员。拥有魔法指示物的正义阵营队员必须选择任务成功，邪恶阵营队员摩根勒菲除外。
                        </div>
                        <label class="magic-token-target-label">选择派发魔法指示物的队员：</label>
                        <select class="magic-token-select" id="magic-token-target">
                            <option value="">不派发魔法指示物</option>
                        </select>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-primary mt-3" onclick="submitTeam()" id="submit-team-button" disabled>
                            确认队员
                        </button>
                    </div>
                </div>

                <!-- 添加任务投票界面 -->
                <div id="quest-vote-controls" style="display: none;">
                    <h3 class="fw-bold mb-3">任务投票</h3>
                    <p>你是本次任务的队员，请选择任务结果：</p>
                    <div id="magic-token-info" class="magic-token-info" style="display: none;">
                        <p><strong>注意：</strong>你拥有魔法指示物，将在投票时自动使用。</p>
                        <p class="mb-0">
                            <span class="badge bg-info">提示</span>
                            魔法指示物会强制正义阵营选择成功，摩根勒菲依然可以选择失败。
                        </p>
                    </div>
                    <div id="vote-result" class="vote-result" style="display: none;">
                        <div class="result-box">
                            <p>你的投票已提交：</p>
                            <div class="vote-badge">
                                <span id="vote-result-badge"></span>
                            </div>
                            <p class="waiting-text">等待其他队员完成投票...</p>
                        </div>
                    </div>
                    <div class="vote-buttons" id="vote-buttons">
                        <button onclick="submitQuestVote(true)" class="success-button">
                            成功
                        </button>
                        <button onclick="submitQuestVote(false)" class="fail-button" id="fail-vote-button">
                            失败
                        </button>
                    </div>
                </div>

                <!-- 添加选择下一任队长界面 -->
                <div id="next-leader-selection" style="display: none;">
                    <h3 class="fw-bold mb-3">选择下一任队长</h3>
                    <div class="alert alert-info">
                        <p><i class="bi bi-info-circle-fill"></i> 作为当前队长，你需要选择下一轮任务的队长。</p>
                        <p><span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle-fill"></i> 注意</span> 新队长必须是没当过队长的玩家。</p>
                        <p>战略提示：选择合适的队长可以影响游戏走向，慎重选择！</p>
                    </div>
                    <div class="players-grid">
                        <!-- 玩家选择列表将由JS动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Rules Section -->
    <div class="game-container rules-container mt-4">
        <div class="accordion" id="gameRulesAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="gameRulesHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gameRulesCollapse" aria-expanded="false" aria-controls="gameRulesCollapse">
                        游戏规则说明
                    </button>
                </h2>
                <div id="gameRulesCollapse" class="accordion-collapse collapse" aria-labelledby="gameRulesHeading" data-bs-parent="#gameRulesAccordion">
                    <div class="accordion-body rules-content">
                        <div class="rules-section">
                            <h3>基本概念</h3>
                            <ul>
                                <li><strong>游戏目标</strong>：正义阵营需要成功完成3次任务获胜，邪恶阵营需要使3次任务失败获胜</li>
                                <li><strong>身份隐藏</strong>：除特殊角色外，玩家不知道其他人的身份</li>
                                <li><strong>任务机制</strong>：每轮由队长选择队员执行任务，队员可以选择任务成功或失败</li>
                            </ul>
                        </div>

                        <div class="rules-section">
                            <h3>游戏流程</h3>
                            <ol>
                                <li><strong>准备阶段</strong>：系统随机分配角色给每个玩家</li>
                                <li><strong>任务阶段</strong>：游戏共有5轮任务，需要完成3次任务判定胜负</li>
                                <li><strong>每轮任务流程</strong>：
                                    <ul>
                                        <li>队长选择一定数量的队员（不同轮次、不同人数要求不同）</li>
                                        <li>队员秘密投票决定任务成功或失败（正义阵营只能选择成功）</li>
                                        <li>任何一票失败都会导致任务失败</li>
                                    </ul>
                                </li>
                                <li><strong>任务结束</strong>：任务成功或失败后，队长选择下一任队长</li>
                                <li><strong>游戏结束</strong>：当一方阵营达成胜利条件时游戏结束</li>
                            </ol>
                        </div>

                        <div class="rules-section">
                            <h3>特殊规则</h3>
                            <p><strong>魔法指示物</strong>：队长可以派发魔法指示物给队员，拥有魔法指示物的队员在执行任务时会自动使用</p>
                            <ul>
                                <li>正义阵营玩家使用魔法指示物时必须选择任务成功</li>
                                <li>邪恶阵营中的摩根勒菲使用魔法指示物时可以选择任务失败</li>
                            </ul>
                        </div>

                        <div class="rules-section">
                            <h3>角色介绍</h3>
                            <div class="roles-container">
                                <div class="roles-column">
                                    <h4>正义阵营</h4>
                                    <ul>
                                        <li><strong>亚瑟的忠臣</strong>：效忠于亚瑟王的正义骑士，不具特殊能力</li>
                                        <li><strong>公爵</strong>：在最终任务中可以指定一位玩家放下一只手</li>
                                        <li><strong>大公</strong>：在最终任务中，邪恶方揭露身份后，可以改变一个玩家一只手的指向</li>
                                    </ul>
                                </div>
                                <div class="roles-column">
                                    <h4>邪恶阵营</h4>
                                    <ul>
                                        <li><strong>摩根勒菲</strong>：不受魔法指示物效果影响，可以投失败票</li>
                                        <li><strong>王储</strong>：不知道邪恶方有谁，但邪恶方知道谁是王储</li>
                                        <li><strong>幻形妖</strong>：邪恶方不知道幻形妖是谁，幻形妖也不知道哪些人是邪恶方</li>
                                        <li><strong>莫德雷德的爪牙</strong>：知道其他邪恶阵营的人（除了幻形妖）</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 在连接时保存玩家名称
        let playerName = '';
        let roomCode = '';

        // Socket.IO 连接
        const socket = io({
            transports: ['websocket', 'polling'],
        });

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        socket.on('player_info', (data) => {
            console.log('Received player_info:', data);
            if (data && data.player_info) {
                updatePlayerInfo(data.player_info);
            }
        });

        socket.on('room_update', (roomInfo) => {
            console.log('Received room update:', roomInfo);
            updateRoomInfo(roomInfo);
        });

        socket.on('game_update', (data) => {
            console.log('Received game update:', data);
            window.currentGameState = data.game_state;
            updateGameView(data.game_state);
        });

        socket.on('game_started', (data) => {
            console.log('Received game_started event:', data);
            window.currentGameState = data.game_state;
            showView('game-view');
            updateGameView(data.game_state);
        });

        socket.on('quest_result', (data) => {
            console.log('Received quest result:', data);
            window.currentGameState = data.game_state;
            alert(`任务${data.success ? '成功' : '失败'}！${data.fail_count > 0 ? `失败票数：${data.fail_count}` : ''}`);
            updateGameView(data.game_state);
        });

        socket.on('game_over', (data) => {
            console.log('Game over:', data);
            const gameState = data.game_state;
            const winner = data.winner;
            
            // Store the quest results for display
            window.currentGameState = gameState;
            
            // Calculate completed quests counts from quest_results array
            const successfulQuests = gameState.quest_results.filter(result => result === true).length;
            const failedQuests = gameState.quest_results.filter(result => result === false).length;
            
            console.log(`Game over results - Success: ${successfulQuests}, Failed: ${failedQuests}, Winner: ${winner}`);
            
            alert(`游戏结束！${winner === 'GOOD' ? '正义阵营' : '邪恶阵营'}获胜！\n任务成功: ${successfulQuests}\n任务失败: ${failedQuests}`);
            updateGameView(gameState);
        });

        // 创建房间
        function createRoom() {
            const playerCountInput = document.getElementById('player-count');
            
            console.log('Create room inputs:', {
                playerCountInput: playerCountInput ? playerCountInput.value : 'not found'
            });

            if (!playerCountInput) {
                console.error('Cannot find input elements');
                return;
            }

            const playerCount = parseInt(playerCountInput.value);

            console.log('Creating room with player count:', playerCount);
            socket.emit('create_room', {
                player_count: playerCount
            }, (response) => {
                console.log('Create room response:', response);
                if (response.error) {
                    alert(response.error);
                } else {
                    // 保存服务器分配的玩家名称
                    playerName = response.player_name;
                    roomCode = response.room_info.code;
                    showView('room-view');
                    updateRoomInfo(response.room_info);
                }
            });
        }

        // 加入房间
        function joinRoom() {
            const roomCodeInput = document.getElementById('join-room-code');
            
            console.log('Join room inputs:', {
                roomCodeInput: roomCodeInput ? roomCodeInput.value : 'not found'
            });

            if (!roomCodeInput) {
                console.error('Cannot find input elements');
                return;
            }

            roomCode = roomCodeInput.value.trim().toUpperCase();
            
            if (!roomCode) {
                alert('请输入房间代码');
                return;
            }

            console.log('Joining room with code:', roomCode);
            socket.emit('join_room', {
                room_code: roomCode
            }, (response) => {
                console.log('Join room response:', response);
                if (response.error) {
                    alert(response.error);
                } else {
                    // 保存服务器分配的玩家名称
                    playerName = response.player_name;
                    showView('room-view');
                    updateRoomInfo(response.room_info);
                }
            });
        }

        function showView(viewId) {
            console.log('Showing view:', viewId);
            // 隐藏所有视图
            const views = ['create-view', 'join-view', 'room-view', 'game-view'];
            views.forEach(view => {
                const element = document.getElementById(view);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // 显示指定视图
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.style.display = 'block';
            }

            // 如果显示游戏视图，隐藏主菜单
            if (viewId === 'game-view') {
                const mainMenu = document.getElementById('main-menu');
                if (mainMenu) {
                    mainMenu.style.display = 'none';
                }
            }
        }

        function showMainMenu() {
            showView('main-menu');
        }

        function showCreateRoom() {
            showView('create-view');
        }

        function showJoinRoom() {
            showView('join-view');
        }

        // 更新房间信息
        function updateRoomInfo(roomInfo) {
            console.log('Updating room info:', roomInfo);
            const roomInfoDiv = document.getElementById('room-info');
            if (!roomInfoDiv) {
                console.error('Cannot find room-info element');
                return;
            }

            // 检查当前玩家是否是房主
            const isCurrentPlayerHost = roomInfo.host_name === playerName;
            console.log('Current player is host:', isCurrentPlayerHost);

            roomInfoDiv.innerHTML = `
                <div class="room-header">
                    <h2 class="text-center">游戏房间</h2>
                    <div class="room-code-container">
                        <div class="room-code">${roomInfo.code}</div>
                        <button class="copy-button" onclick="copyRoomCode('${roomInfo.code}')">复制</button>
                        <div id="copy-message" class="copy-message">已复制</div>
                    </div>
                    <p class="player-count text-center">玩家数量: ${roomInfo.players.length}/${roomInfo.player_count}</p>
                </div>
                <div class="players-list">
                    <h3 class="text-center mb-4">玩家列表</h3>
                    <div class="player-cards">
                        ${roomInfo.players.map(player => `
                            <div class="player-item ${player.is_host ? 'host' : ''}">
                                <span class="player-number">#${player.player_number}</span>
                                <span class="player-name">${player.name}</span>
                                ${player.is_host ? '<span class="badge bg-primary ms-2">房主</span>' : ''}
                                ${player.name === playerName ? '<span class="badge bg-success ms-2">你</span>' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${isCurrentPlayerHost ? `
                    <div class="host-controls">
                        <button 
                            onclick="startGame()" 
                            class="start-button"
                            ${roomInfo.players.length === roomInfo.player_count ? '' : 'disabled'}
                        >
                            开始游戏
                        </button>
                        ${roomInfo.players.length === roomInfo.player_count ? '' : 
                            `<p class="waiting-message mt-3">等待玩家加入 (${roomInfo.players.length}/${roomInfo.player_count})</p>`}
                    </div>
                ` : `
                    <div class="waiting-message">
                        <p>等待房主开始游戏...</p>
                    </div>
                `}
            `;

            console.log('Room info updated successfully');
        }

        // 开始游戏
        function startGame() {
            console.log('Starting game...');
            socket.emit('start_game', {
                room_code: roomCode,
                player_name: playerName
            }, (response) => {
                console.log('Start game response:', response);
                if (response.error) {
                    alert(response.error);
                }
            });
        }

        function updatePlayerInfo(playerInfo) {
            console.log('Updating player info:', playerInfo);
            
            // 获取自己的角色信息
            const selfInfo = playerInfo.find(info => info.is_self);
            
            // 更新我的角色信息
            const myRoleInfo = document.getElementById('my-role-info');
            if (myRoleInfo && selfInfo) {
                myRoleInfo.innerHTML = `
                    <div class="self-info">
                        <p><strong>角色:</strong> ${selfInfo.role}</p>
                        <p><strong>阵营:</strong> ${selfInfo.team_display}</p>
                        <p><strong>描述:</strong> ${selfInfo.role_description || ''}</p>
                    </div>
                `;
                
                // 如果是摩根勒菲，显示可见的邪恶角色信息
                if (selfInfo.role === '摩根勒菲') {
                    const evilPlayers = playerInfo.filter(info => 
                        !info.is_self && info.team === 'EVIL' && info.role);
                    
                    if (evilPlayers.length > 0) {
                        myRoleInfo.innerHTML += `
                            <div class="visible-players mt-3">
                                <p><strong>你能看到的邪恶角色:</strong></p>
                                <ul>
                                    ${evilPlayers.map(player => 
                                        `<li>${player.name}: ${player.role || '未知'}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                }
                
                // 如果是莫德雷德的爪牙，显示摩根勒菲和王储信息
                if (selfInfo.role === '莫德雷德的爪牙') {
                    const visiblePlayers = playerInfo.filter(info => 
                        !info.is_self && info.role && (info.role === '摩根勒菲' || info.role === '王儲'));
                    
                    if (visiblePlayers.length > 0) {
                        myRoleInfo.innerHTML += `
                            <div class="visible-players mt-3">
                                <p><strong>你能看到的邪恶角色:</strong></p>
                                <ul>
                                    ${visiblePlayers.map(player => 
                                        `<li>${player.name}: ${player.role || '未知'}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                }
            }
            
            // 更新所有玩家列表，包括可见的信息
            const playersList = document.getElementById('players-list');
            if (playersList) {
                playersList.innerHTML = playerInfo.map(info => `
                    <div class="player-card ${info.is_leader ? 'leader' : ''} ${info.is_self ? 'self' : ''}">
                        <span class="player-number">#${info.number}</span>
                        <div class="player-name">${info.name}</div>
                        ${info.is_self ? `
                            <div class="player-role">${info.role}</div>
                            <div class="player-team">${info.team_display}</div>
                        ` : 
                        info.team ? `
                            <div class="player-team">${info.team_display || getTeamDisplayName(info.team)}</div>
                            ${info.role ? `<div class="player-role">${info.role}</div>` : ''}
                        ` : ''
                        }
                        ${info.is_leader ? '<div class="leader-badge">队长</div>' : ''}
                    </div>
                `).join('');
                
                // 标记玩家列表已由player_info初始化
                playersList.setAttribute('data-initialized-by-player-info', 'true');
            }
        }

        function getTeamDisplayName(team) {
            const teamNames = {
                'GOOD': '正义阵营',
                'EVIL': '邪恶阵营'
            };
            return teamNames[team] || '未知';
        }

        // 复制房间代码
        function copyRoomCode(code) {
            // 使用navigator.clipboard API复制文本
            navigator.clipboard.writeText(code)
                .then(() => {
                    console.log('房间代码已复制:', code);
                    // 显示复制成功消息
                    const copyMessage = document.getElementById('copy-message');
                    if (copyMessage) {
                        copyMessage.classList.add('show');
                        // 2秒后隐藏消息
                        setTimeout(() => {
                            copyMessage.classList.remove('show');
                        }, 2000);
                    }
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败，请手动复制房间代码。');
                });
        }

        function updateGameStatus(gameState) {
            console.log('Updating game status:', gameState);
            // 更新任务信息
            const questInfo = document.getElementById('quest-info');
            questInfo.innerHTML = `
                <div class="quest-status">
                    <div>当前任务：第 ${gameState.quest_number} 轮</div>
                    <div>需要队员：${gameState.current_quest.required_players} 人</div>
                    <div>任务结果：${gameState.quest_results.map((result, i) => 
                        `第${i + 1}轮: ${result ? '成功' : '失败'}`).join(', ') || '无'}</div>
                </div>
            `;

            // 更新领袖选择界面
            const leaderControls = document.getElementById('leader-controls');
            if (gameState.current_leader === playerName) {
                leaderControls.style.display = 'block';
                updateTeamSelection(gameState);
            } else {
                leaderControls.style.display = 'none';
            }
        }

        function updateTeamSelection(gameState) {
            const teamSelection = document.getElementById('team-selection');
            teamSelection.innerHTML = gameState.players.map(player => `
                <div class="form-check ${selectedTeam.has(player.name) ? 'selected' : ''}" 
                     onclick="toggleTeamSelection('${player.name}')">
                    <input type="checkbox" 
                           id="select-${player.name}" 
                           value="${player.name}"
                           ${selectedTeam.has(player.name) ? 'checked' : ''}
                           style="pointer-events: none;">
                    <label for="select-${player.name}" style="pointer-events: none;">
                        <div class="player-details">
                            <span class="player-number">#${player.player_number}</span>
                            <span>${player.name}</span>
                        </div>
                        ${player.magic_tokens > 0 ? `<span class="magic-token">魔法 x${player.magic_tokens}</span>` : ''}
                    </label>
                </div>
            `).join('');
            
            // 更新魔法指示物选择下拉框
            updateMagicTokenDropdown();
        }

        function updateMagicTokenDropdown() {
            const magicTokenSelect = document.getElementById('magic-token-target');
            if (!magicTokenSelect) return;
            
            // 清空现有选项，保留第一个
            const firstOption = magicTokenSelect.firstElementChild;
            magicTokenSelect.innerHTML = '';
            magicTokenSelect.appendChild(firstOption);
            
            // 只添加已选中的队员
            Array.from(selectedTeam).forEach(playerName => {
                const option = document.createElement('option');
                option.value = playerName;
                option.textContent = playerName;
                magicTokenSelect.appendChild(option);
            });
        }

        // 添加新函数用于处理整行点击
        function toggleTeamSelection(playerName) {
            console.log('Toggling team selection for:', playerName);
            const checkbox = document.getElementById(`select-${playerName}`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                handleTeamSelection(playerName);
                
                // 更新选中状态的样式
                const formCheck = checkbox.closest('.form-check');
                if (formCheck) {
                    formCheck.classList.toggle('selected', checkbox.checked);
                }
            }
        }

        function handleTeamSelection(playerName) {
            console.log('Handling team selection for:', playerName);
            const checkbox = document.getElementById(`select-${playerName}`);
            const gameState = window.currentGameState;

            if (!checkbox || !gameState) {
                console.error('Missing required elements');
                return;
            }

            if (checkbox.checked) {
                selectedTeam.add(playerName);
            } else {
                selectedTeam.delete(playerName);
            }

            // 更新提交按钮状态
            const submitButton = document.getElementById('submit-team-button');
            if (submitButton) {
                const requiredPlayers = gameState.current_quest.required_players;
                submitButton.disabled = selectedTeam.size !== requiredPlayers;
                console.log(`Selected team size: ${selectedTeam.size}, Required: ${requiredPlayers}`);
            } else {
                console.error('Submit team button not found');
            }
            
            // 更新魔法指示物下拉框
            updateMagicTokenDropdown();
        }

        function submitTeam() {
            console.log('Submitting team:', Array.from(selectedTeam));
            
            const gameState = window.currentGameState;
            if (!gameState) {
                console.error('Game state not found');
                return;
            }
            
            const requiredPlayers = gameState.current_quest.required_players;
            console.log(`Required team size: ${requiredPlayers}, Current selection size: ${selectedTeam.size}`);
            
            if (selectedTeam.size !== requiredPlayers) {
                alert(`请选择 ${requiredPlayers} 名队员`);
                return;
            }
            
            // 获取选择的魔法指示物目标
            const magicTokenTarget = document.getElementById('magic-token-target').value;
            console.log('Magic token target:', magicTokenTarget);

            console.log('Sending team selection to server...');
            socket.emit('submit_team', {
                room_code: roomCode,
                team: Array.from(selectedTeam),
                magic_token_target: magicTokenTarget || null
            }, (response) => {
                console.log('Submit team response:', response);
                if (response.error) {
                    alert(response.error);
                } else {
                    console.log('Team submitted successfully');
                    selectedTeam.clear();
                }
            });
        }
        
        // 添加选择下一任队长的函数
        function selectNextLeader(nextLeaderName) {
            console.log('Selecting next leader:', nextLeaderName);
            socket.emit('select_next_leader', {
                room_code: roomCode,
                next_leader: nextLeaderName,
                player_name: playerName  // 添加当前玩家名称
            }, (response) => {
                console.log('Select next leader response:', response);
                if (response.error) {
                    alert(response.error);
                }
            });
        }

        function leaveRoom() {
            socket.emit('leave_room', {
                room_code: roomCode,
                player_name: playerName
            }, (response) => {
                if (response.error) {
                    alert(response.error);
                    return;
                }
                showMainMenu();
            });
        }

        // 页面关闭时离开房间
        window.onbeforeunload = function() {
            if (roomCode && playerName) {
                socket.emit('leave_room', {
                    room_code: roomCode,
                    player_name: playerName
                });
            }
        };

        // 确保HTML结构正确
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking elements...');
            const requiredElements = {
                'player-name': document.getElementById('player-name'),
                'room-code': document.getElementById('room-code'),
                'create-view': document.getElementById('create-view'),
                'room-view': document.getElementById('room-view'),
                'game-view': document.getElementById('game-view')
            };

            for (const [id, element] of Object.entries(requiredElements)) {
                if (!element) {
                    console.error(`Missing required element: ${id}`);
                } else {
                    console.log(`Found element: ${id}`);
                }
            }
        });

        // 添加游戏视图更新函数
        function updateGameView(gameState) {
            console.log('Updating game view with state:', gameState);
            const gameView = document.getElementById('game-view');
            if (!gameView) {
                console.error('Cannot find game-view element');
                return;
            }

            // 获取当前玩家信息
            const currentPlayer = gameState.players.find(p => p.name === playerName);
            const isLeader = gameState.current_leader === playerName;
            const isInTeam = gameState.current_quest.team.some(p => p.name === playerName);

            // 更新游戏状态头部
            const gameStatusHeader = document.getElementById('game-status-header');
            if (gameStatusHeader) {
                gameStatusHeader.innerHTML = `
                    <p>当前任务: <span class="badge bg-primary">${gameState.quest_number}</span></p>
                    <p>当前阶段: <span class="badge bg-info">${gameState.current_phase}</span></p>
                    <p>当前队长: <span class="badge bg-warning text-dark">${gameState.current_leader}</span></p>
                    <p>需要选择 <span class="badge bg-success">${gameState.current_quest.required_players}</span> 名玩家</p>
                `;
            }

            // 更新玩家列表 - 总是更新队长状态
            const playersList = document.getElementById('players-list');
            if (playersList) {
                // 保留现有的角色信息，但更新队长和团队状态
                const existingCards = playersList.querySelectorAll('.player-card');
                
                if (existingCards.length === 0) {
                    // 如果没有现有卡片，则完全重新生成
                    playersList.innerHTML = gameState.players.map(player => `
                        <div class="player-card ${player.is_leader ? 'leader' : ''} 
                                          ${player.name === playerName ? 'self' : ''} 
                                          ${gameState.current_quest.team.some(p => p.name === player.name) ? 'selected-team' : ''}">
                            <span class="player-number">#${player.player_number}</span>
                            <div class="player-name">${player.name}</div>
                            ${player.magic_tokens > 0 ? `<span class="magic-token">魔法 x${player.magic_tokens}</span>` : ''}
                            ${player.is_leader ? '<div class="leader-badge">队长</div>' : ''}
                            ${gameState.current_quest.team.some(p => p.name === player.name) ? 
                                '<div class="team-badge">任务队员</div>' : ''}
                        </div>
                    `).join('');
                } else {
                    // 更新现有卡片的状态
                    existingCards.forEach(card => {
                        const playerName = card.querySelector('.player-name').textContent;
                        const player = gameState.players.find(p => p.name === playerName);
                        
                        if (player) {
                            // 更新队长状态
                            card.classList.toggle('leader', player.is_leader);
                            
                            // 更新队长徽章
                            let leaderBadge = card.querySelector('.leader-badge');
                            if (player.is_leader) {
                                if (!leaderBadge) {
                                    leaderBadge = document.createElement('div');
                                    leaderBadge.className = 'leader-badge';
                                    leaderBadge.textContent = '队长';
                                    card.appendChild(leaderBadge);
                                }
                            } else if (leaderBadge) {
                                leaderBadge.remove();
                            }
                            
                            // 更新团队状态
                            const isInTeam = gameState.current_quest.team.some(p => p.name === playerName);
                            card.classList.toggle('selected-team', isInTeam);
                            
                            // 更新团队徽章
                            let teamBadge = card.querySelector('.team-badge');
                            if (isInTeam) {
                                if (!teamBadge) {
                                    teamBadge = document.createElement('div');
                                    teamBadge.className = 'team-badge';
                                    teamBadge.textContent = '任务队员';
                                    card.appendChild(teamBadge);
                                }
                            } else if (teamBadge) {
                                teamBadge.remove();
                            }
                            
                            // 更新魔法指示物
                            const magicTokenSpan = card.querySelector('.magic-token');
                            if (player.magic_tokens > 0) {
                                if (!magicTokenSpan) {
                                    const newTokenSpan = document.createElement('span');
                                    newTokenSpan.className = 'magic-token';
                                    newTokenSpan.textContent = `魔法 x${player.magic_tokens}`;
                                    card.querySelector('.player-name').after(newTokenSpan);
                                } else {
                                    magicTokenSpan.textContent = `魔法 x${player.magic_tokens}`;
                                }
                            } else if (magicTokenSpan) {
                                magicTokenSpan.remove();
                            }
                        }
                    });
                }
            }

            // 更新任务信息
            const questInfo = document.getElementById('quest-info');
            if (questInfo) {
                questInfo.innerHTML = `
                    <div class="quest-status">
                        <div><strong>当前任务：</strong> 第 ${gameState.quest_number} 轮</div>
                        <div><strong>需要队员：</strong> ${gameState.current_quest.required_players} 人</div>
                        <div><strong>任务结果：</strong> 
                            ${gameState.quest_results.length > 0 ? 
                              gameState.quest_results.map((result, i) => 
                                `<span class="badge ${result ? 'bg-success' : 'bg-danger'}">第${i + 1}轮: ${result ? '成功' : '失败'}</span>`
                              ).join(' ') 
                              : '无'}
                        </div>
                    </div>
                `;
            }

            // 更新队长控制区域
            const leaderControls = document.getElementById('leader-controls');
            if (leaderControls) {
                leaderControls.style.display = isLeader && gameState.current_phase === 'LEADER_TURN' ? 'block' : 'none';
                if (isLeader && gameState.current_phase === 'LEADER_TURN') {
                    updateTeamSelection(gameState);
                }
            }

            // 更新任务投票区域
            const questVoteControls = document.getElementById('quest-vote-controls');
            if (questVoteControls) {
                if (gameState.current_phase === 'QUEST_VOTE' && isInTeam) {
                    questVoteControls.style.display = 'block';
                    
                    // 显示魔法指示物信息
                    const magicTokenInfo = document.getElementById('magic-token-info');
                    if (magicTokenInfo && currentPlayer && currentPlayer.magic_tokens > 0) {
                        magicTokenInfo.style.display = 'block';
                    } else if (magicTokenInfo) {
                        magicTokenInfo.style.display = 'none';
                    }
                    
                    // 检查玩家是否已投票
                    const hasVoted = gameState.current_quest.votes.includes(playerName);
                    const voteButtons = document.getElementById('vote-buttons');
                    const voteResult = document.getElementById('vote-result');
                    
                    if (hasVoted) {
                        if (voteButtons) voteButtons.style.display = 'none';
                        if (voteResult) voteResult.style.display = 'block';
                    } else {
                        if (voteButtons) voteButtons.style.display = 'flex';
                        if (voteResult) voteResult.style.display = 'none';
                        
                        // 邪恶阵营可以投失败票，或者摩根勒菲且有魔法指示物
                        const canVoteFail = currentPlayer.team === 'EVIL' || 
                                         (currentPlayer.role === '摩根勒菲' && currentPlayer.magic_tokens > 0);
                        
                        // 如果有魔法指示物但不是摩根勒菲，禁用失败按钮
                        const failButton = document.getElementById('fail-vote-button');
                        if (failButton) {
                            if (currentPlayer.magic_tokens > 0 && currentPlayer.role !== '摩根勒菲') {
                                failButton.style.display = 'none';
                            } else if (!canVoteFail) {
                                failButton.style.display = 'none';
                            } else {
                                failButton.style.display = 'inline-block';
                            }
                        }
                    }
                } else {
                    questVoteControls.style.display = 'none';
                }
            }

            // 如果不是在投票，但是当前阶段是投票阶段，显示等待信息
            if (gameState.current_phase === 'QUEST_VOTE' && !isInTeam) {
                // 添加一个等待消息到game-content
                const gameContent = document.querySelector('.game-content');
                if (gameContent) {
                    // 检查是否已经有等待消息
                    let waitingMessage = document.getElementById('waiting-message');
                    if (!waitingMessage) {
                        waitingMessage = document.createElement('div');
                        waitingMessage.id = 'waiting-message';
                        waitingMessage.className = 'waiting-message';
                        gameContent.appendChild(waitingMessage);
                    }
                    waitingMessage.innerHTML = `
                        <p>等待任务队员进行投票...</p>
                        <p>当前任务队员：${gameState.current_quest.team.map(p => p.name).join(', ')}</p>
                    `;
                }
            } else {
                // 移除等待消息
                const waitingMessage = document.getElementById('waiting-message');
                if (waitingMessage) {
                    waitingMessage.remove();
                }
            }

            // 更新选择下一任队长区域
            const nextLeaderSelection = document.getElementById('next-leader-selection');
            if (nextLeaderSelection) {
                if (gameState.current_phase === 'SELECT_NEXT_LEADER' && isLeader) {
                    nextLeaderSelection.style.display = 'block';
                    const playersGrid = nextLeaderSelection.querySelector('.players-grid');
                    if (playersGrid) {
                        // 生成除了当前队长之外的所有玩家列表
                        playersGrid.innerHTML = gameState.players.map(player => {
                            if (player.name !== playerName) {
                                const hasBeenLeader = player.has_been_leader;
                                const playerCardClass = hasBeenLeader ? 'player-card disabled-player' : 'player-card';
                                return `
                                    <div class="${playerCardClass}">
                                        <span class="player-number">#${player.player_number}</span>
                                        <div class="player-name">${player.name}</div>
                                        <div class="player-role mt-2">
                                            ${player.magic_tokens > 0 ? 
                                                `<span class="magic-token">魔法 x${player.magic_tokens}</span>` : ''}
                                            ${hasBeenLeader ? 
                                                `<span class="badge bg-secondary">已当过队长</span>` : ''}
                                        </div>
                                        ${!hasBeenLeader ? 
                                            `<button onclick="selectNextLeader('${player.name}')" 
                                                    class="select-leader-button mt-3">
                                                选为队长
                                            </button>` : 
                                            `<button class="select-leader-button mt-3 disabled" disabled>
                                                不可选择
                                            </button>`}
                                    </div>
                                `;
                            }
                            return '';
                        }).join('');
                    }
                } else {
                    nextLeaderSelection.style.display = 'none';
                }
            }

            // 如果不是在选择下一任队长，但是当前阶段是选择下一任队长，显示等待信息
            if (gameState.current_phase === 'SELECT_NEXT_LEADER' && !isLeader) {
                // 添加一个等待消息到game-content
                const gameContent = document.querySelector('.game-content');
                if (gameContent) {
                    // 检查是否已经有等待消息
                    let waitingMessage = document.getElementById('waiting-next-leader');
                    if (!waitingMessage) {
                        waitingMessage = document.createElement('div');
                        waitingMessage.id = 'waiting-next-leader';
                        waitingMessage.className = 'waiting-message';
                        gameContent.appendChild(waitingMessage);
                    }
                    waitingMessage.innerHTML = `
                        <h4 class="text-center mb-3">任务已完成</h4>
                        <div class="alert alert-warning">
                            <p><strong>任务结果:</strong> ${gameState.quest_results[gameState.quest_results.length-1] ? 
                                '<span class="badge bg-success">成功</span>' : 
                                '<span class="badge bg-danger">失败</span>'}
                            </p>
                            <p>等待当前队长 <strong>${gameState.current_leader}</strong> 选择下一任队长...</p>
                            <p><i class="bi bi-info-circle-fill"></i> 规则：新队长必须是没当过队长的玩家</p>
                            <p>下一轮任务需要 ${gameState.current_quest.required_players} 名队员</p>
                        </div>
                    `;
                }
            } else {
                // 移除等待消息
                const waitingMessage = document.getElementById('waiting-next-leader');
                if (waitingMessage) {
                    waitingMessage.remove();
                }
            }

            // 添加游戏结束状态
            if (gameState.current_phase === 'GAME_OVER') {
                // 添加一个游戏结束消息到game-content
                const gameContent = document.querySelector('.game-content');
                if (gameContent) {
                    // 检查是否已经有游戏结束消息
                    let gameOverMsg = document.getElementById('game-over-msg');
                    if (!gameOverMsg) {
                        gameOverMsg = document.createElement('div');
                        gameOverMsg.id = 'game-over-msg';
                        gameOverMsg.className = 'game-over';
                        gameContent.appendChild(gameOverMsg);
                    }
                    
                    // 计算任务结果
                    const successfulQuests = gameState.quest_results.filter(result => result === true).length;
                    const failedQuests = gameState.quest_results.filter(result => result === false).length;
                    const winner = successfulQuests >= 3 ? 'GOOD' : 'EVIL';
                    
                    gameOverMsg.innerHTML = `
                        <h2>游戏结束</h2>
                        <p class="winner-announcement">
                            ${winner === 'GOOD' ? '正义阵营' : '邪恶阵营'}获胜！
                        </p>
                        <div class="final-results">
                            <p>任务成功: ${successfulQuests}</p>
                            <p>任务失败: ${failedQuests}</p>
                            <p>完成任务: ${successfulQuests + failedQuests}/5</p>
                        </div>
                        <div class="quest-results mt-3">
                            <h4>任务详情:</h4>
                            <div class="d-flex justify-content-center gap-2 mt-2">
                                ${gameState.quest_results.map((result, index) => 
                                    `<span class="badge ${result ? 'bg-success' : 'bg-danger'} p-2">
                                        第${index + 1}轮: ${result ? '成功' : '失败'}
                                    </span>`
                                ).join(' ')}
                            </div>
                        </div>
                        <button onclick="location.reload()" class="new-game-button">
                            开始新游戏
                        </button>
                    `;
                }
            } else {
                // 移除游戏结束消息
                const gameOverMsg = document.getElementById('game-over-msg');
                if (gameOverMsg) {
                    gameOverMsg.remove();
                }
            }
        }

        // 添加队伍选择相关函数
        let selectedTeam = new Set();

        function submitQuestVote(success) {
            console.log('Submitting quest vote:', success);
            socket.emit('submit_quest_vote', {
                room_code: roomCode,
                player_name: playerName,
                success: success
            }, (response) => {
                console.log('Quest vote response:', response);
                if (response.error) {
                    alert(response.error);
                } else {
                    // 显示投票结果
                    const voteButtons = document.getElementById('vote-buttons');
                    const voteResult = document.getElementById('vote-result');
                    const voteResultBadge = document.getElementById('vote-result-badge');
                    
                    if (voteButtons) voteButtons.style.display = 'none';
                    if (voteResult) voteResult.style.display = 'block';
                    
                    if (voteResultBadge) {
                        voteResultBadge.textContent = response.vote ? '成功' : '失败';
                        voteResultBadge.className = response.vote ? 
                            'badge bg-success p-2' : 'badge bg-danger p-2';
                    }
                }
            });
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿瓦隆游戏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            background-image: url('https://img.freepik.com/free-vector/hand-painted-watercolor-fantasy-background_23-2149012322.jpg?w=1380&t=st=1715642564~exp=1715643164~hmac=04e1f6d41dfee5d80d48108fa44339ba75e2e82a0fde1b35a6eb62cd1ac6b2fc');
            background-size: cover;
            background-attachment: fixed;
            color: #333;
            line-height: 1.6;
        }
        .game-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        h1.main-title {
            color: #2e4172;
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            font-family: 'Times New Roman', Times, serif;
        }
        .title-subtitle {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin-top: -20px;
            margin-bottom: 30px;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
            margin-bottom: 30px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .card-title {
            color: #2e4172;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .card-body {
            padding: 25px;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 1rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        .btn:hover::after {
            animation: ripple 1s ease-out;
        }
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        .btn-primary {
            background-color: #3266c1;
            color: white;
        }
        .btn-primary:hover {
            background-color: #274d94;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: #38b000;
            color: white;
        }
        .btn-success:hover {
            background-color: #2d8c00;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #bb2d3b;
            transform: translateY(-2px);
        }
        #main-menu {
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
        }
        #main-menu .card-body {
            padding: 40px;
        }
        #main-menu .btn {
            min-width: 180px;
            margin: 10px;
            font-size: 1.1rem;
            padding: 12px 24px;
        }
        #create-view, #join-view {
            background: white;
        }
        .room-header {
            margin-bottom: 30px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        .room-code {
            font-size: 2rem;
            font-weight: 700;
            color: #3266c1;
            letter-spacing: 3px;
            margin: 15px 0;
            display: block;
            text-align: center;
            text-transform: uppercase;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .player-count {
            font-size: 1.2rem;
            color: #6c757d;
            margin-top: 10px;
        }
        .players-list {
            margin: 30px 0;
        }
        .players-list h3 {
            color: #2e4172;
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .player-item {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3266c1;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        .player-item:hover {
            transform: translateX(5px);
            background-color: #e9ecef;
        }
        .player-item.host {
            border-left-color: #38b000;
            font-weight: 600;
        }
        .player-number {
            font-weight: 700;
            margin-right: 12px;
            display: inline-block;
            background-color: #3266c1;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .host-controls {
            margin-top: 30px;
            text-align: center;
        }
        .start-button {
            min-width: 200px;
            padding: 12px 25px;
            font-size: 1.1rem;
            background-color: #38b000;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
            background-color: #2d8c00;
        }
        .start-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .waiting-message {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        /* Game View Styles */
        #game-view {
            background: white;
        }
        #game-view .card-body {
            padding: 0;
        }
        .game-header {
            background: linear-gradient(135deg, #2e4172 0%, #192640 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }
        .game-header h2 {
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .game-header p {
            margin: 5px 0;
            font-size: 1.1rem;
        }
        .game-content {
            padding: 25px;
        }
        .role-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3266c1;
        }
        .role-info .self-info {
            font-size: 1.1rem;
        }
        .role-info p {
            margin: 8px 0;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .player-card {
            position: relative;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .player-card.leader {
            border: 2px solid #ffc107;
        }
        .player-card.self {
            border: 2px solid #3266c1;
        }
        .player-card.selected-team {
            border: 2px solid #38b000;
        }
        .player-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 10px 0;
        }
        .player-role, .player-team {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .leader-badge, .team-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #ffc107;
            color: #212529;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .team-badge {
            background-color: #38b000;
            color: white;
            top: auto;
            bottom: -10px;
        }
        .quest-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .quest-status div {
            margin: 8px 0;
            font-size: 1rem;
        }
        .leader-controls, .quest-vote-controls, .next-leader-selection {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        .team-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .form-check {
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
            cursor: pointer;
        }
        .form-check:hover {
            transform: scale(1.03);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .form-check input {
            margin-right: 10px;
        }
        .vote-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .success-button, .fail-button {
            min-width: 150px;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .success-button {
            background-color: #38b000;
            color: white;
        }
        .success-button:hover {
            transform: translateY(-3px) scale(1.05);
            background-color: #2d8c00;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .fail-button {
            background-color: #dc3545;
            color: white;
        }
        .fail-button:hover {
            transform: translateY(-3px) scale(1.05);
            background-color: #bb2d3b;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .select-leader-button {
            padding: 8px 16px;
            background-color: #3266c1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .select-leader-button:hover {
            background-color: #274d94;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .game-over {
            text-align: center;
            padding: 30px;
            margin: 20px 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        .winner-announcement {
            font-size: 2rem;
            font-weight: 700;
            margin: 20px 0;
            color: #2e4172;
        }
        .final-results {
            margin: 20px 0;
            font-size: 1.2rem;
        }
        .new-game-button {
            min-width: 200px;
            padding: 12px 25px;
            background-color: #3266c1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .new-game-button:hover {
            transform: translateY(-3px);
            background-color: #274d94;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="main-title">阿瓦隆传奇</h1>
        <p class="title-subtitle">亚瑟王的骑士们，正义与邪恶的终极对决</p>
        
        <!-- 主菜单 -->
        <div id="main-menu" class="card mb-4">
            <div class="card-body text-center">
                <h5 class="card-title">欢迎来到阿瓦隆游戏</h5>
                <p class="mb-4">探索正义与邪恶的史诗对决，展开你的冒险吧！</p>
                <div class="d-flex justify-content-center flex-wrap">
                    <button class="btn btn-primary m-2" onclick="showCreateRoom()">创建房间</button>
                    <button class="btn btn-success m-2" onclick="showJoinRoom()">加入房间</button>
                </div>
            </div>
        </div>

        <!-- 创建房间 -->
        <div id="create-view" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">创建新房间</h5>
                <p class="text-muted mb-4">创建一个新的游戏房间，邀请你的朋友加入吧！</p>
                <div class="mb-4">
                    <label for="create-player-name" class="form-label">你的名称</label>
                    <input type="text" class="form-control" id="create-player-name" placeholder="输入你的游戏名称">
                </div>
                <div class="mb-4">
                    <label for="player-count" class="form-label">选择玩家数量</label>
                    <select class="form-select" id="player-count">
                        <option value="5">5人游戏</option>
                        <option value="6">6人游戏</option>
                        <option value="7">7人游戏</option>
                        <option value="8">8人游戏</option>
                        <option value="9">9人游戏</option>
                        <option value="10">10人游戏</option>
                    </select>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-secondary" onclick="showMainMenu()">返回</button>
                    <button class="btn btn-primary" onclick="createRoom()">创建房间</button>
                </div>
            </div>
        </div>

        <!-- 加入房间 -->
        <div id="join-view" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">加入房间</h5>
                <p class="text-muted mb-4">输入房间代码和你的名称加入已有的游戏</p>
                <div class="mb-4">
                    <label for="join-player-name" class="form-label">你的名称</label>
                    <input type="text" id="join-player-name" class="form-control" placeholder="输入你的游戏名称" required>
                </div>
                <div class="mb-4">
                    <label for="join-room-code" class="form-label">房间代码</label>
                    <input type="text" id="join-room-code" class="form-control" maxlength="4" placeholder="输入4位房间代码" required>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-secondary" onclick="showMainMenu()">返回</button>
                    <button onclick="joinRoom()" class="btn btn-success">加入房间</button>
                </div>
            </div>
        </div>

        <!-- 房间界面 -->
        <div id="room-view" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h5 class="card-title text-center">游戏房间</h5>
                <div id="room-info"></div>
                <div class="text-center">
                    <button class="btn btn-danger mt-3" onclick="leaveRoom()">离开房间</button>
                </div>
            </div>
        </div>

        <!-- 游戏界面 -->
        <div id="game-view" class="card mb-4" style="display: none;">
            <div class="game-header">
                <h2>阿瓦隆传奇</h2>
                <div id="game-status-header"></div>
            </div>
            <div class="game-content">
                <!-- 个人角色信息 -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">你的角色信息</h6>
                    <div id="my-role-info" class="role-info"></div>
                </div>

                <!-- 玩家列表 -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">玩家信息</h6>
                    <div id="players-list" class="players-grid"></div>
                </div>

                <!-- 任务信息 -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">任务信息</h6>
                    <div id="quest-info" class="quest-info"></div>
                </div>

                <!-- 领袖选择界面 -->
                <div id="leader-controls" class="mb-4" style="display: none;">
                    <h6 class="fw-bold mb-3">选择任务队员</h6>
                    <div id="team-selection"></div>
                    <div class="text-center">
                        <button class="btn btn-primary mt-3" onclick="submitTeam()" id="submit-team-btn" disabled>
                            确认队员
                        </button>
                    </div>
                </div>

                <!-- 添加任务投票界面 -->
                <div id="quest-vote-controls" style="display: none;">
                    <h3 class="fw-bold mb-3">任务投票</h3>
                    <p>你是本次任务的队员，请选择任务结果：</p>
                    <div class="vote-buttons">
                        <button onclick="submitQuestVote(true)" class="success-button">
                            成功
                        </button>
                        <button onclick="submitQuestVote(false)" class="fail-button">
                            失败
                        </button>
                    </div>
                </div>

                <!-- 添加选择下一任队长界面 -->
                <div id="next-leader-selection" style="display: none;">
                    <h3 class="fw-bold mb-3">选择下一任队长</h3>
                    <div class="players-grid">
                        ${gameState.players.map(player => `
                            ${player.name !== playerName ? `
                                <div class="player-card">
                                    <span class="player-number">#${player.player_number}</span>
                                    <div class="player-name">${player.name}</div>
                                    <button onclick="selectNextLeader('${player.name}')" 
                                            class="select-leader-button">
                                        选为队长
                                    </button>
                                </div>
                            ` : ''}
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 在连接时保存玩家名称
        let playerName = '';
        let roomCode = '';

        // Socket.IO 连接
        const socket = io({
            transports: ['websocket', 'polling'],
        });

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        socket.on('player_info', (data) => {
            console.log('Received player_info:', data);
            if (data && data.player_info) {
                updatePlayerInfo(data.player_info);
            }
        });

        socket.on('room_update', (roomInfo) => {
            console.log('Received room update:', roomInfo);
            updateRoomInfo(roomInfo);
        });

        socket.on('game_update', (data) => {
            console.log('Received game update:', data);
            window.currentGameState = data.game_state;
            updateGameView(data.game_state);
        });

        socket.on('game_started', (data) => {
            console.log('Received game_started event:', data);
            window.currentGameState = data.game_state;
            showView('game-view');
            updateGameView(data.game_state);
        });

        socket.on('quest_result', (data) => {
            console.log('Received quest result:', data);
            window.currentGameState = data.game_state;
            alert(`任务${data.success ? '成功' : '失败'}！${data.fail_count > 0 ? `失败票数：${data.fail_count}` : ''}`);
            updateGameView(data.game_state);
        });

        socket.on('game_over', (data) => {
            console.log('Game over:', data);
            const gameState = data.game_state;
            const successfulQuests = gameState.successful_quests || 0;
            const failedQuests = gameState.failed_quests || 0;
            alert(`游戏结束！${successfulQuests >= 3 ? '正义阵营' : '邪恶阵营'}获胜！\n任务成功: ${successfulQuests}\n任务失败: ${failedQuests}`);
            updateGameView(gameState);
        });

        // 创建房间
        function createRoom() {
            const playerNameInput = document.getElementById('create-player-name');
            const playerCountInput = document.getElementById('player-count');
            
            console.log('Create room inputs:', {
                playerNameInput: playerNameInput ? playerNameInput.value : 'not found',
                playerCountInput: playerCountInput ? playerCountInput.value : 'not found'
            });

            if (!playerNameInput || !playerCountInput) {
                console.error('Cannot find input elements');
                return;
            }

            playerName = playerNameInput.value.trim();
            const playerCount = parseInt(playerCountInput.value);
            
            if (!playerName) {
                alert('请输入玩家名称');
                return;
            }

            console.log('Creating room with:', { playerName, playerCount });
            socket.emit('create_room', {
                player_count: playerCount,
                host_name: playerName
            }, (response) => {
                console.log('Create room response:', response);
                if (response.error) {
                    alert(response.error);
                } else {
                    roomCode = response.room_info.code;
                    showView('room-view');
                    updateRoomInfo(response.room_info);
                }
            });
        }

        // 加入房间
        function joinRoom() {
            const playerNameInput = document.getElementById('join-player-name');
            const roomCodeInput = document.getElementById('join-room-code');
            
            console.log('Join room inputs:', {
                playerNameInput: playerNameInput ? playerNameInput.value : 'not found',
                roomCodeInput: roomCodeInput ? roomCodeInput.value : 'not found'
            });

            if (!playerNameInput || !roomCodeInput) {
                console.error('Cannot find input elements');
                return;
            }

            playerName = playerNameInput.value.trim();
            roomCode = roomCodeInput.value.trim().toUpperCase();
            
            if (!playerName || !roomCode) {
                alert('请输入玩家名称和房间代码');
                return;
            }

            console.log('Joining room with:', { playerName, roomCode });
            socket.emit('join_room', {
                room_code: roomCode,
                player_name: playerName
            }, (response) => {
                console.log('Join room response:', response);
                if (response.error) {
                    alert(response.error);
                } else {
                    showView('room-view');
                    updateRoomInfo(response.room_info);
                }
            });
        }

        function showView(viewId) {
            console.log('Showing view:', viewId);
            // 隐藏所有视图
            const views = ['create-view', 'join-view', 'room-view', 'game-view'];
            views.forEach(view => {
                const element = document.getElementById(view);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // 显示指定视图
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.style.display = 'block';
            }

            // 如果显示游戏视图，隐藏主菜单
            if (viewId === 'game-view') {
                const mainMenu = document.getElementById('main-menu');
                if (mainMenu) {
                    mainMenu.style.display = 'none';
                }
            }
        }

        function showMainMenu() {
            showView('main-menu');
        }

        function showCreateRoom() {
            showView('create-view');
        }

        function showJoinRoom() {
            showView('join-view');
        }

        // 更新房间信息
        function updateRoomInfo(roomInfo) {
            console.log('Updating room info:', roomInfo);
            const roomInfoDiv = document.getElementById('room-info');
            if (!roomInfoDiv) {
                console.error('Cannot find room-info element');
                return;
            }

            // 检查当前玩家是否是房主
            const isCurrentPlayerHost = roomInfo.host_name === playerName;
            console.log('Current player is host:', isCurrentPlayerHost);

            roomInfoDiv.innerHTML = `
                <div class="room-header">
                    <h2 class="text-center">游戏房间</h2>
                    <div class="room-code">${roomInfo.code}</div>
                    <p class="player-count text-center">玩家数量: ${roomInfo.players.length}/${roomInfo.player_count}</p>
                </div>
                <div class="players-list">
                    <h3 class="text-center mb-4">玩家列表</h3>
                    <div class="player-cards">
                        ${roomInfo.players.map(player => `
                            <div class="player-item ${player.is_host ? 'host' : ''}">
                                <span class="player-number">#${player.player_number}</span>
                                <span class="player-name">${player.name}</span>
                                ${player.is_host ? '<span class="badge bg-primary ms-2">房主</span>' : ''}
                                ${player.name === playerName ? '<span class="badge bg-success ms-2">你</span>' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${isCurrentPlayerHost ? `
                    <div class="host-controls">
                        <button 
                            onclick="startGame()" 
                            class="start-button"
                            ${roomInfo.players.length === roomInfo.player_count ? '' : 'disabled'}
                        >
                            开始游戏
                        </button>
                        ${roomInfo.players.length === roomInfo.player_count ? '' : 
                            `<p class="waiting-message mt-3">等待玩家加入 (${roomInfo.players.length}/${roomInfo.player_count})</p>`}
                    </div>
                ` : `
                    <div class="waiting-message">
                        <p>等待房主开始游戏...</p>
                    </div>
                `}
            `;

            console.log('Room info updated successfully');
        }

        // 开始游戏
        function startGame() {
            console.log('Starting game...');
            socket.emit('start_game', {
                room_code: roomCode,
                player_name: playerName
            }, (response) => {
                console.log('Start game response:', response);
                if (response.error) {
                    alert(response.error);
                }
            });
        }

        function updatePlayerInfo(playerInfo) {
            console.log('Updating player info:', playerInfo);
            const gameView = document.getElementById('game-view');
            if (!gameView) {
                console.error('Cannot find game-view element');
                return;
            }

            // 更新玩家信息区域
            const playerInfoDiv = document.createElement('div');
            playerInfoDiv.className = 'player-info';
            playerInfoDiv.innerHTML = `
                <h3>你的角色信息:</h3>
                <div class="role-info">
                    ${playerInfo.map(info => {
                        if (info.is_self) {
                            return `
                                <div class="self-info">
                                    <p>角色: ${info.role}</p>
                                    <p>阵营: ${info.team_display}</p>
                                </div>
                            `;
                        }
                        return '';
                    }).join('')}
                </div>
            `;

            // 如果已存在则替换，否则添加
            const existingInfo = gameView.querySelector('.player-info');
            if (existingInfo) {
                existingInfo.replaceWith(playerInfoDiv);
            } else {
                gameView.insertBefore(playerInfoDiv, gameView.firstChild);
            }
        }

        function getTeamDisplayName(team) {
            const teamNames = {
                'GOOD': '正义阵营',
                'EVIL': '邪恶阵营'
            };
            return teamNames[team] || '未知';
        }

        function updateGameStatus(gameState) {
            console.log('Updating game status:', gameState);
            // 更新任务信息
            const questInfo = document.getElementById('quest-info');
            questInfo.innerHTML = `
                <div class="quest-status">
                    <div>当前任务：第 ${gameState.quest_number} 轮</div>
                    <div>需要队员：${gameState.current_quest.required_players} 人</div>
                    <div>任务结果：${gameState.quest_results.map((result, i) => 
                        `第${i + 1}轮: ${result ? '成功' : '失败'}`).join(', ') || '无'}</div>
                </div>
            `;

            // 更新领袖选择界面
            const leaderControls = document.getElementById('leader-controls');
            if (gameState.current_leader === playerName) {
                leaderControls.style.display = 'block';
                updateTeamSelection(gameState);
            } else {
                leaderControls.style.display = 'none';
            }
        }

        function updateTeamSelection(gameState) {
            const teamSelection = document.getElementById('team-selection');
            teamSelection.innerHTML = gameState.players.map(player => `
                <div class="form-check">
                    <input type="checkbox" 
                           id="select-${player.name}" 
                           value="${player.name}"
                           onchange="handleTeamSelection('${player.name}')"
                           ${selectedTeam.has(player.name) ? 'checked' : ''}>
                    <label for="select-${player.name}">
                        <span class="player-number">#${player.player_number}</span>
                        ${player.name}
                    </label>
                </div>
            `).join('');
        }

        function checkTeamSize(requiredPlayers) {
            const selectedPlayers = document.querySelectorAll('#team-selection input:checked');
            const submitButton = document.getElementById('submit-team-btn');
            submitButton.disabled = selectedPlayers.length !== requiredPlayers;
        }

        function submitTeam() {
            console.log('Submitting team:', Array.from(selectedTeam));
            if (selectedTeam.size !== window.currentGameState.current_quest.required_players) {
                alert(`请选择 ${window.currentGameState.current_quest.required_players} 名队员`);
                return;
            }

            socket.emit('submit_team', {
                room_code: roomCode,
                team: Array.from(selectedTeam)
            }, (response) => {
                console.log('Submit team response:', response);
                if (response.error) {
                    alert(response.error);
                } else {
                    selectedTeam.clear();
                }
            });
        }

        function leaveRoom() {
            socket.emit('leave_room', {
                room_code: roomCode,
                player_name: playerName
            }, (response) => {
                if (response.error) {
                    alert(response.error);
                    return;
                }
                showMainMenu();
            });
        }

        // 页面关闭时离开房间
        window.onbeforeunload = function() {
            if (roomCode && playerName) {
                socket.emit('leave_room', {
                    room_code: roomCode,
                    player_name: playerName
                });
            }
        };

        // 确保HTML结构正确
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking elements...');
            const requiredElements = {
                'player-name': document.getElementById('player-name'),
                'room-code': document.getElementById('room-code'),
                'create-view': document.getElementById('create-view'),
                'room-view': document.getElementById('room-view'),
                'game-view': document.getElementById('game-view')
            };

            for (const [id, element] of Object.entries(requiredElements)) {
                if (!element) {
                    console.error(`Missing required element: ${id}`);
                } else {
                    console.log(`Found element: ${id}`);
                }
            }
        });

        // 添加游戏视图更新函数
        function updateGameView(gameState) {
            console.log('Updating game view with state:', gameState);
            const gameView = document.getElementById('game-view');
            if (!gameView) {
                console.error('Cannot find game-view element');
                return;
            }

            // 获取当前玩家信息
            const currentPlayer = gameState.players.find(p => p.name === playerName);
            const isLeader = gameState.current_leader === playerName;
            const isInTeam = gameState.current_quest.team.some(p => p.name === playerName);

            // 更新游戏状态头部
            const gameStatusHeader = document.getElementById('game-status-header');
            if (gameStatusHeader) {
                gameStatusHeader.innerHTML = `
                    <p>当前任务: <span class="badge bg-primary">${gameState.quest_number}</span></p>
                    <p>当前阶段: <span class="badge bg-info">${gameState.current_phase}</span></p>
                    <p>当前队长: <span class="badge bg-warning text-dark">${gameState.current_leader}</span></p>
                    <p>需要选择 <span class="badge bg-success">${gameState.current_quest.required_players}</span> 名玩家</p>
                `;
            }

            // 更新角色信息
            const roleInfo = document.getElementById('my-role-info');
            if (roleInfo && currentPlayer) {
                roleInfo.innerHTML = `
                    <div class="self-info">
                        <p><strong>角色:</strong> ${currentPlayer.role || "未知"}</p>
                        <p><strong>阵营:</strong> ${currentPlayer.team_display || "未知"}</p>
                    </div>
                `;
            }

            // 更新玩家列表
            const playersList = document.getElementById('players-list');
            if (playersList) {
                playersList.innerHTML = gameState.players.map(player => `
                    <div class="player-card ${player.is_leader ? 'leader' : ''} 
                                      ${player.name === playerName ? 'self' : ''} 
                                      ${gameState.current_quest.team.some(p => p.name === player.name) ? 'selected-team' : ''}">
                        <span class="player-number">#${player.player_number}</span>
                        <div class="player-name">${player.name}</div>
                        ${player.name === playerName ? `
                            <div class="player-role">${player.role}</div>
                            <div class="player-team">${player.team_display}</div>
                        ` : ''}
                        ${player.is_leader ? '<div class="leader-badge">队长</div>' : ''}
                        ${gameState.current_quest.team.some(p => p.name === player.name) ? 
                            '<div class="team-badge">任务队员</div>' : ''}
                    </div>
                `).join('');
            }

            // 更新任务信息
            const questInfo = document.getElementById('quest-info');
            if (questInfo) {
                questInfo.innerHTML = `
                    <div class="quest-status">
                        <div><strong>当前任务：</strong> 第 ${gameState.quest_number} 轮</div>
                        <div><strong>需要队员：</strong> ${gameState.current_quest.required_players} 人</div>
                        <div><strong>任务结果：</strong> 
                            ${gameState.quest_results.length > 0 ? 
                              gameState.quest_results.map((result, i) => 
                                `<span class="badge ${result ? 'bg-success' : 'bg-danger'}">第${i + 1}轮: ${result ? '成功' : '失败'}</span>`
                              ).join(' ') 
                              : '无'}
                        </div>
                    </div>
                `;
            }

            // 更新队长控制区域
            const leaderControls = document.getElementById('leader-controls');
            if (leaderControls) {
                leaderControls.style.display = isLeader && gameState.current_phase === 'LEADER_TURN' ? 'block' : 'none';
                if (isLeader && gameState.current_phase === 'LEADER_TURN') {
                    const teamSelection = document.getElementById('team-selection');
                    if (teamSelection) {
                        teamSelection.innerHTML = gameState.players.map(player => `
                            <div class="form-check">
                                <input type="checkbox" 
                                       id="select-${player.name}" 
                                       value="${player.name}"
                                       onchange="handleTeamSelection('${player.name}')"
                                       ${selectedTeam.has(player.name) ? 'checked' : ''}>
                                <label for="select-${player.name}">
                                    <span class="player-number">#${player.player_number}</span>
                                    ${player.name}
                                </label>
                            </div>
                        `).join('');
                    }
                }
            }

            // 更新任务投票区域
            const questVoteControls = document.getElementById('quest-vote-controls');
            if (questVoteControls) {
                if (gameState.current_phase === 'QUEST_VOTE' && isInTeam) {
                    questVoteControls.style.display = 'block';
                    // 邪恶阵营可以投失败票
                    const voteButtons = questVoteControls.querySelector('.vote-buttons');
                    if (voteButtons && currentPlayer.team === 'EVIL') {
                        voteButtons.innerHTML = `
                            <button onclick="submitQuestVote(true)" class="success-button">
                                成功
                            </button>
                            <button onclick="submitQuestVote(false)" class="fail-button">
                                失败
                            </button>
                        `;
                    } else if (voteButtons) {
                        // 正义阵营只能投成功票
                        voteButtons.innerHTML = `
                            <button onclick="submitQuestVote(true)" class="success-button">
                                成功
                            </button>
                        `;
                    }
                } else {
                    questVoteControls.style.display = 'none';
                }
            }

            // 如果不是在投票，但是当前阶段是投票阶段，显示等待信息
            if (gameState.current_phase === 'QUEST_VOTE' && !isInTeam) {
                // 添加一个等待消息到game-content
                const gameContent = document.querySelector('.game-content');
                if (gameContent) {
                    // 检查是否已经有等待消息
                    let waitingMessage = document.getElementById('waiting-message');
                    if (!waitingMessage) {
                        waitingMessage = document.createElement('div');
                        waitingMessage.id = 'waiting-message';
                        waitingMessage.className = 'waiting-message';
                        gameContent.appendChild(waitingMessage);
                    }
                    waitingMessage.innerHTML = `
                        <p>等待任务队员进行投票...</p>
                        <p>当前任务队员：${gameState.current_quest.team.map(p => p.name).join(', ')}</p>
                    `;
                }
            } else {
                // 移除等待消息
                const waitingMessage = document.getElementById('waiting-message');
                if (waitingMessage) {
                    waitingMessage.remove();
                }
            }

            // 更新选择下一任队长区域
            const nextLeaderSelection = document.getElementById('next-leader-selection');
            if (nextLeaderSelection) {
                if (gameState.current_phase === 'SELECT_NEXT_LEADER' && isLeader) {
                    nextLeaderSelection.style.display = 'block';
                    const playersGrid = nextLeaderSelection.querySelector('.players-grid');
                    if (playersGrid) {
                        playersGrid.innerHTML = gameState.players.map(player => `
                            ${player.name !== playerName ? `
                                <div class="player-card">
                                    <span class="player-number">#${player.player_number}</span>
                                    <div class="player-name">${player.name}</div>
                                    <button onclick="selectNextLeader('${player.name}')" 
                                            class="select-leader-button">
                                        选为队长
                                    </button>
                                </div>
                            ` : ''}
                        `).join('');
                    }
                } else {
                    nextLeaderSelection.style.display = 'none';
                }
            }

            // 如果不是在选择下一任队长，但是当前阶段是选择下一任队长，显示等待信息
            if (gameState.current_phase === 'SELECT_NEXT_LEADER' && !isLeader) {
                // 添加一个等待消息到game-content
                const gameContent = document.querySelector('.game-content');
                if (gameContent) {
                    // 检查是否已经有等待消息
                    let waitingMessage = document.getElementById('waiting-next-leader');
                    if (!waitingMessage) {
                        waitingMessage = document.createElement('div');
                        waitingMessage.id = 'waiting-next-leader';
                        waitingMessage.className = 'waiting-message';
                        gameContent.appendChild(waitingMessage);
                    }
                    waitingMessage.innerHTML = `
                        <p>等待当前队长 ${gameState.current_leader} 选择下一任队长...</p>
                    `;
                }
            } else {
                // 移除等待消息
                const waitingMessage = document.getElementById('waiting-next-leader');
                if (waitingMessage) {
                    waitingMessage.remove();
                }
            }

            // 添加游戏结束状态
            if (gameState.current_phase === 'GAME_OVER') {
                // 添加一个游戏结束消息到game-content
                const gameContent = document.querySelector('.game-content');
                if (gameContent) {
                    // 检查是否已经有游戏结束消息
                    let gameOverMsg = document.getElementById('game-over-msg');
                    if (!gameOverMsg) {
                        gameOverMsg = document.createElement('div');
                        gameOverMsg.id = 'game-over-msg';
                        gameOverMsg.className = 'game-over';
                        gameContent.appendChild(gameOverMsg);
                    }
                    gameOverMsg.innerHTML = `
                        <h2>游戏结束</h2>
                        <p class="winner-announcement">
                            ${gameState.successful_quests >= 3 ? '正义阵营' : '邪恶阵营'}获胜！
                        </p>
                        <div class="final-results">
                            <p>任务成功: ${gameState.successful_quests || 0}</p>
                            <p>任务失败: ${gameState.failed_quests || 0}</p>
                        </div>
                        <button onclick="location.reload()" class="new-game-button">
                            开始新游戏
                        </button>
                    `;
                }
            } else {
                // 移除游戏结束消息
                const gameOverMsg = document.getElementById('game-over-msg');
                if (gameOverMsg) {
                    gameOverMsg.remove();
                }
            }
        }

        // 添加队伍选择相关函数
        let selectedTeam = new Set();

        function handleTeamSelection(playerName) {
            console.log('Handling team selection for:', playerName);
            const checkbox = document.getElementById(`select-${playerName}`);
            const gameState = window.currentGameState;

            if (!checkbox || !gameState) {
                console.error('Missing required elements');
                return;
            }

            if (checkbox.checked) {
                selectedTeam.add(playerName);
            } else {
                selectedTeam.delete(playerName);
            }

            // 更新提交按钮状态
            const submitButton = document.getElementById('submit-team-button');
            if (submitButton) {
                submitButton.disabled = selectedTeam.size !== gameState.current_quest.required_players;
                console.log(`Selected team size: ${selectedTeam.size}, Required: ${gameState.current_quest.required_players}`);
            }
        }

        function submitQuestVote(success) {
            console.log('Submitting quest vote:', success);
            socket.emit('submit_quest_vote', {
                room_code: roomCode,
                player_name: playerName,
                success: success
            }, (response) => {
                console.log('Quest vote response:', response);
                if (response.error) {
                    alert(response.error);
                }
            });
        }

        // 添加选择下一任队长的函数
        function selectNextLeader(nextLeaderName) {
            console.log('Selecting next leader:', nextLeaderName);
            socket.emit('select_next_leader', {
                room_code: roomCode,
                next_leader: nextLeaderName
            }, (response) => {
                console.log('Select next leader response:', response);
                if (response.error) {
                    alert(response.error);
                }
            });
        }
    </script>
</body>
</html> 
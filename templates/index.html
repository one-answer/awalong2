<!DOCTYPE html>
<html>
<head>
    <title>阿瓦隆在线</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        .quest-result {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin: 0 5px;
            border-radius: 50%;
        }
        .success {
            background-color: blue;
        }
        .fail {
            background-color: red;
        }
        .vote-track {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin: 0 3px;
            border: 1px solid black;
            border-radius: 50%;
        }
        .vote-track.active {
            background-color: red;
        }
        button {
            margin: 5px;
            padding: 5px 10px;
        }
        .role-info {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .setup-options {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .create-game, .join-game {
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 45%;
        }
        
        input[type="text"] {
            padding: 5px;
            margin: 5px 0;
            width: 200px;
        }
        
        .game-id {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        
        .copy-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .copy-button:hover {
            background-color: #45a049;
        }
        
        .room-info {
            background-color: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .room-info p {
            margin: 5px 0;
        }
        
        .connected-player {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background-color: #4CAF50;
            color: white;
            border-radius: 3px;
        }
        .player-info {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .player-info p {
            margin: 5px 0;
            font-weight: bold;
        }
        
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }
        
        #assassin-targets {
            margin: 10px 0;
        }
        
        #assassin-targets button {
            margin: 5px;
            padding: 8px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #assassin-targets button:hover {
            background-color: #c82333;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <h1>阿瓦隆在线</h1>
    
    <!-- 游戏创建界面 -->
    <div id="setup-screen">
        <h2>阿瓦隆在线</h2>
        <div class="setup-options">
            <div class="create-game">
                <h3>创建新游戏</h3>
                <label>玩家数量：
                    <select id="player-count">
                        <option value="5">5人</option>
                        <option value="6">6人</option>
                        <option value="7">7人</option>
                        <option value="8">8人</option>
                        <option value="9">9人</option>
                        <option value="10">10人</option>
                    </select>
                </label>
                <button onclick="createGame()">创建游戏</button>
            </div>

            <div class="join-game">
                <h3>加入游戏</h3>
                <input type="text" id="game-id-input" placeholder="输入游戏ID">
                <button onclick="joinExistingGame()">加入游戏</button>
            </div>
        </div>
    </div>

    <!-- 角色选择界面 -->
    <div id="role-screen" class="hidden">
        <h2>等待游戏开始</h2>
        <div class="room-info">
            <p>房间人数: <span id="player-count-display"></span> 人</p>
            <p>已加入玩家: <span id="connected-players"></span></p>
            <p>你的编号: <span id="your-player-number"></span></p>
        </div>
        <div id="role-info" class="role-info hidden">
            <h3>你的角色信息</h3>
            <p id="role-name"></p>
            <p id="role-special-info"></p>
        </div>
    </div>

    <!-- 游戏主界面 -->
    <div id="game-screen" class="hidden">
        <h2>游戏进行中</h2>
        <div id="game-info">
            <div class="player-info">
                <p>你的编号：玩家<span id="game-player-number"></span></p>
                <p>你的角色：<span id="game-player-role"></span></p>
            </div>
            <hr>
            <p>当前任务：<span id="current-quest"></span></p>
            <p>任务结果：<span id="quest-results"></span></p>
            <p>需要人数：<span id="required-players"></span></p>
            <p>当前队长：玩家<span id="current-leader"></span></p>
            <p>投票追踪：<span id="vote-track"></span></p>
        </div>

        <div id="team-selection" class="hidden">
            <h3>选择队员</h3>
            <div id="team-selection-buttons"></div>
            <button onclick="submitTeam()">确认选择</button>
        </div>

        <div id="team-vote" class="hidden">
            <h3>队伍投票</h3>
            <button onclick="submitTeamVote(true)">同意</button>
            <button onclick="submitTeamVote(false)">反对</button>
        </div>

        <div id="quest-vote" class="hidden">
            <h3>任务投票</h3>
            <button onclick="submitQuestVote(true)">成功</button>
            <button onclick="submitQuestVote(false)">失败</button>
        </div>

        <div id="assassin-phase" class="hidden">
            <h3>刺客阶段</h3>
            <p>请选择要刺杀的目标：</p>
            <div id="assassin-targets"></div>
        </div>
    </div>

    <script>
        let socket = io({
            transports: ['websocket'],
            upgrade: false
        });
        let gameId = null;
        let playerId = null;
        let playerRole = null;

        // Socket.io 事件处理
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('error', (data) => {
            alert(data.message);
        });

        socket.on('game_created', (data) => {
            gameId = data.game_id;
            
            // 创建一个显示游戏ID的元素
            const gameIdDisplay = document.createElement('div');
            gameIdDisplay.className = 'game-id';
            gameIdDisplay.innerHTML = `
                游戏ID（请复制分享给其他玩家）：<br>
                <span style="font-size: 1.2em; font-weight: bold;">${gameId}</span><br>
                <button class="copy-button" onclick="copyGameId('${gameId}')">复制</button>
            `;
            
            document.querySelector('.create-game').appendChild(gameIdDisplay);
        });

        socket.on('role_info', (data) => {
            playerRole = data.role;
            document.getElementById('role-name').textContent = `你的角色是：${data.role}`;
            if (data.evil_players) {
                document.getElementById('role-special-info').textContent = 
                    `你看到的邪恶方玩家是：${data.evil_players.join(', ')}`;
            }
            document.getElementById('role-info').classList.remove('hidden');
        });

        socket.on('game_state', (data) => {
            // 确保游戏主界面显示
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            // 显示玩家信息
            document.getElementById('game-player-number').textContent = playerId + 1;
            document.getElementById('game-player-role').textContent = playerRole;
            
            document.getElementById('current-quest').textContent = data.current_quest;
            document.getElementById('required-players').textContent = data.required_players;
            document.getElementById('current-leader').textContent = data.leader;
            
            // 更新任务结果
            const questResults = document.getElementById('quest-results');
            questResults.innerHTML = '';
            data.quest_results.forEach(result => {
                const dot = document.createElement('div');
                dot.className = `quest-result ${result === '成功' ? 'success' : 'fail'}`;
                questResults.appendChild(dot);
            });
            
            // 更新投票追踪
            const voteTrack = document.getElementById('vote-track');
            voteTrack.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const dot = document.createElement('div');
                dot.className = `vote-track${i < data.vote_track ? ' active' : ''}`;
                voteTrack.appendChild(dot);
            }
            
            // 显示相应的操作界面
            if (data.leader === playerId + 1) {  // 因为playerId是从0开始的
                document.getElementById('team-selection').classList.remove('hidden');
                // 创建队员选择复选框
                const teamSelectionButtons = document.getElementById('team-selection-buttons');
                teamSelectionButtons.innerHTML = '';
                for (let i = 1; i <= data.player_count; i++) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `team-member-${i}`;
                    checkbox.value = i;
                    
                    const label = document.createElement('label');
                    label.htmlFor = `team-member-${i}`;
                    label.textContent = `玩家${i}`;
                    
                    teamSelectionButtons.appendChild(checkbox);
                    teamSelectionButtons.appendChild(label);
                    teamSelectionButtons.appendChild(document.createElement('br'));
                }
            } else {
                document.getElementById('team-selection').classList.add('hidden');
            }
        });

        socket.on('team_proposed', (data) => {
            document.getElementById('team-selection').classList.add('hidden');
            document.getElementById('team-vote').classList.remove('hidden');
            // 清除之前的队员信息
            const oldTeamInfo = document.querySelector('#team-vote p');
            if (oldTeamInfo) {
                oldTeamInfo.remove();
            }
            // 显示被提名的队员
            const selectedTeam = data.team.map(id => `玩家${id}`).join(', ');
            document.getElementById('team-vote').insertAdjacentHTML('afterbegin', 
                `<p>提名队员：${selectedTeam}</p>`);
        });

        socket.on('team_vote_result', (data) => {
            document.getElementById('team-vote').classList.add('hidden');
            // 显示投票结果
            const voteResults = Object.entries(data.votes)
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))  // 按玩家编号排序
                .map(([pid, vote]) => `玩家${parseInt(pid) + 1}: ${vote ? '同意' : '反对'}`)
                .join(', ');
            alert(`投票结果：${voteResults}`);
            
            if (data.success) {
                // 检查当前玩家是否在任务队员中
                if (data.team.includes(playerId + 1)) {
                    document.getElementById('quest-vote').classList.remove('hidden');
                }
                // 显示被选中的队员
                const questInfo = document.createElement('p');
                questInfo.textContent = `执行任务的队员：${data.team.map(id => `玩家${id}`).join(', ')}`;
                document.getElementById('game-info').appendChild(questInfo);
                // 清除之前的队员信息
                const oldTeamInfo = document.querySelector('#team-vote p');
                if (oldTeamInfo) {
                    oldTeamInfo.remove();
                }
            }
        });

        socket.on('quest_vote_result', (data) => {
            document.getElementById('quest-vote').classList.add('hidden');
            // 移除之前显示的队员信息
            const questInfo = document.getElementById('game-info').lastElementChild;
            if (questInfo && questInfo.textContent.includes('执行任务的队员')) {
                questInfo.remove();
            }
            // 显示任务投票结果
            const voteCount = data.vote_count;
            alert(`任务结果：成功${voteCount.success}票，失败${voteCount.fail}票`);
            
            if (data.game_over && playerRole === '刺客') {
                document.getElementById('assassin-phase').classList.remove('hidden');
                // 创建刺杀目标选择按钮
                const assassinTargets = document.getElementById('assassin-targets');
                assassinTargets.innerHTML = '';
                for (let i = 1; i <= parseInt(document.getElementById('player-count-display').textContent); i++) {
                    if (i !== playerId + 1) {  // 不能刺杀自己
                        const button = document.createElement('button');
                        button.textContent = `刺杀玩家${i}`;
                        button.onclick = () => {
                            if (confirm(`确定要刺杀玩家${i}吗？`)) {
                                assassinate(i);
                                document.getElementById('assassin-phase').classList.add('hidden');
                            }
                        };
                        assassinTargets.appendChild(button);
                    }
                }
            }
            if (data.game_over) {
                alert(data.message);
            }
        });

        socket.on('assassination_result', (data) => {
            alert(data.message);
            // 可以添加重新开始游戏的选项
        });

        socket.on('game_validated', (data) => {
            if (data.valid) {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('role-screen').classList.remove('hidden');
                
                // 显示房间人数
                document.getElementById('player-count-display').textContent = data.player_count;
                
                // 显示已连接的玩家
                updateConnectedPlayers(data.connected_players || []);
                
                // 自动加入游戏
                socket.emit('join_game', { game_id: gameId });
            } else {
                alert('游戏ID不存在或游戏已结束');
            }
        });

        // 添加玩家加入事件处理
        socket.on('player_joined', (data) => {
            // 如果是当前玩家加入，保存玩家ID
            if (playerId === null) {
                playerId = data.player_id;
                document.getElementById('your-player-number').textContent = data.player_id + 1;
            }
            updateConnectedPlayers(data.connected_players);
            
            // 只有当所有玩家都加入后才开始游戏
            if (data.all_players_joined) {
                document.getElementById('role-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
            }
        });

        // 添加玩家离开事件处理
        socket.on('player_left', (data) => {
            updateConnectedPlayers(data.connected_players);
        });

        // 更新已连接玩家显示
        function updateConnectedPlayers(players) {
            const container = document.getElementById('connected-players');
            container.innerHTML = '';
            
            // 显示已连接玩家
            players.sort((a, b) => a - b).forEach(pid => {
                const span = document.createElement('span');
                span.className = 'connected-player';
                span.textContent = `玩家${pid + 1}`;
                container.appendChild(span);
            });
        }

        // 用户操作函数
        function createGame() {
            const playerCount = document.getElementById('player-count').value;
            socket.emit('create_game', { player_count: playerCount });
        }

        function submitTeam() {
            const checkboxes = document.querySelectorAll('#team-selection-buttons input:checked');
            if (checkboxes.length !== parseInt(document.getElementById('required-players').textContent)) {
                alert('请选择正确数量的队员');
                return;
            }
            const team = Array.from(checkboxes).map(cb => parseInt(cb.value));
            socket.emit('propose_team', { game_id: gameId, team: team });
        }

        function submitTeamVote(approve) {
            socket.emit('team_vote', {
                game_id: gameId,
                player_id: playerId + 1,  // 转换为显示用的ID
                vote: approve
            });
            document.getElementById('team-vote').classList.add('hidden');
        }

        function submitQuestVote(success) {
            socket.emit('quest_vote', {
                game_id: gameId,
                player_id: playerId + 1,  // 转换为显示用的ID
                vote: success
            });
        }

        function assassinate(target) {
            socket.emit('assassinate', {
                game_id: gameId,
                target: target
            });
        }

        function joinExistingGame() {
            const inputGameId = document.getElementById('game-id-input').value.trim();
            if (!inputGameId) {
                alert('请输入游戏ID');
                return;
            }
            gameId = inputGameId;
            
            // 验证游戏ID是否存在
            socket.emit('validate_game', { game_id: gameId });
            // 清空输入框
            document.getElementById('game-id-input').value = '';
        }

        function copyGameId(id) {
            navigator.clipboard.writeText(id).then(() => {
                const copyButton = document.querySelector('.copy-button');
                const originalText = copyButton.textContent;
                copyButton.textContent = '已复制！';
                setTimeout(() => {
                    copyButton.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制游戏ID');
            });
        }
    </script>
</body>
</html> 